# ---------------------------
# GCP Deployment recipes
# ---------------------------

# Deploy pubsub-to-langsmith function (reads from .env file)
deploy-pubsub:
    #!/usr/bin/env bash
    set -euo pipefail
    cd pubsub_to_langsmith
    if [ ! -f .env ]; then
        echo "Error: .env file not found in pubsub_to_langsmith/"
        echo "Create it with: LANGSMITH_PROJECT, LANGSMITH_API_KEY_CLOUD_FUNCTIONS, LOG_LEVEL"
        exit 1
    fi
    # Load .env file
    export $(grep -v '^#' .env | xargs)
    echo "Deploying with LANGSMITH_PROJECT=${LANGSMITH_PROJECT}"
    gcloud functions deploy pubsub-to-langsmith \
        --region=us-central1 \
        --runtime=python313 \
        --source=. \
        --entry-point=pubsub_to_langsmith \
        --trigger-topic=user-event-signups \
        --set-env-vars LANGSMITH_PROJECT="${LANGSMITH_PROJECT}",LOG_LEVEL="${LOG_LEVEL:-INFO}" \
        --set-secrets LANGSMITH_API_KEY_CLOUD_FUNCTIONS=LANGSMITH_API_KEY_CLOUD_FUNCTIONS:latest

publish-test-event:
    #!/usr/bin/env bash
    gcloud pubsub topics publish user-event-signups --message='Ralph from Tennessee.'

logs-tail:
    #!/usr/bin/env bash
    gcloud functions logs read pubsub-to-langsmith --region=us-central1
